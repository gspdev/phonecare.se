<?php $repairUrl = Mage::getBaseUrl(); ?>
<style>
    .repair-form {
        max-width: 740px;
        margin: 0 auto;
    }

    @media only screen and (max-width: 770px) {
        .repair-form {
            text-align: center;
        }
    }

    .page-title.repair-head {
        border: none;
        padding: 0;
        margin: 0;
    }

    .page-title.repair-head h1 {
        margin: 0 0 20px 0;
        text-align: center;
        text-transform: uppercase;
        color: #434343;
        font: 700 30px/1.15 "SF Pro Display","Helvetica Neue","Helvetica","Arial",sans-serif;
    }

    .repair-title {
        text-align: center;
        text-transform: uppercase;
        color: #434343;
        font: 700 20px/1.35 "SF Pro Display","Helvetica Neue","Helvetica","Arial",sans-serif;
        margin: 0 0 1rem;
    }

    .repair-title span {
        font: 700 20px/1.35 "SF Pro Display","Helvetica Neue","Helvetica","Arial",sans-serif;
    }

    .repair-step {
        width: 40px;
        height: 40px;
        display: inline-block;
        background: #2db8c7;
        color: #fff;
        line-height: 40px;
        border-radius: 20px;
        font-size: 30px;
        margin: 0 10px;
    }

    .repair-step > span {
        font: 700 30px/1.35 "SF Pro Display","Helvetica Neue","Helvetica","Arial",sans-serif;
    }

    .repair-form h4 {
        margin-top: 1.6em;
        color: #333333;
        font: 600 16px/1.35 "SF Pro Display","Helvetica Neue","Helvetica","Arial",sans-serif;
    }
    .listBox{padding: 0 0 40px 0;background: #f9f9f9;border:1px solid #fc6908;border-radius: 2px;}
    .listBox h4{color: #fc6908;}
    .repair-form button {
        margin-top: 2em;
        float: right;
    }

    .repair-form input {
        width: 100%;
    }

    .repair-form textarea {
        width: 100%;
        height: 150px;
    }

    .repair-form textarea.small {
        width: 100%;
        height: 75px;
    }

    #poll-answers li label ,#shipping-store li label{
        font: 500 14px/1.55 "SF Pro Display","Helvetica Neue","Helvetica","Arial",sans-serif;
        color: #000;
    }

    #order {
        background-color: #5cb35d;
        border-width: 1px;
        border-style: solid;
        border-color: #5cb35d;
        color: #fff;
        font-size: 14px;
        text-transform: uppercase;
        padding: 9px 14px;
        -webkit-appearance: none;
        transition: all linear 0.25s;
        -webkit-transition: all linear 0.25s;
        -moz-transition: all linear 0.25s;
        -o-transition: all linear 0.25s;
    }

    #order:focus, #order:hover {
        background-color: #666;
        border-color: #666;
    }

    .repairList {
        display: none;
        position: absolute;
        z-index: 100;
        background: #fff;
        width: 80%;
        max-height: 200px;
        padding: 0;
        overflow-y: auto;
    }


    .repairList.active {
        display: block;
        border: 1px solid #c1c4bc;
    }

    .repairList li {
        padding: 4px 10px;
    }

    .repairList li:hover {
        background: #c1c4bc;
        color: #fff;
    }

    .repairList li .img, .repairList li .name {
        display: inline-block;
        float: left;
    }


    .repairList li .img{
        width: 60px;
        height: 60px;
        float: left;
    }
    .repairList li .name {
        padding: 20px 20px 10px 0;
    }
    .listBox .head {
        position: relative;
        padding: 6px 10px;
        border: 1px solid #cccccc;
        color: #000;
        height: 36px;
        background: #ffffff;
        box-shadow: 0 1px 4px rgba(0,0,0,0.1);
    }
    /*.listBox .head::after {
        content: '';
        position: absolute;
        right: 6px;
        top: 14px;
        border-style: solid;
        border-width: 5px;
        border-color: #666 transparent transparent;
    }*/

    .listBox .head.loading::after {
        content: '';
        position: absolute;
        width: 16px;
        height: 16px;
        top: 9px;
        right: 6px;
        border-style: solid;
        border-color: #2db8c7;
        border-width: 4px;
        border-radius: 50%;
        animation: loading 2s linear infinite alternate;
        -webkit-animation: loadCategory 700ms linear infinite alternate;
        -moz-animation: loadCategory 700ms linear infinite alternate;
        -o-animation: loadCategory 700ms linear infinite alternate;
    }

    @keyframes loadCategory {
        from {
            transform: scale(1);
        }
        to {
            transform: scale(0.1);
        }
    }

    @-webkit-keyframes loadCategory {
        from {
            transform: scale(1);
        }
        to {
            transform: scale(0.1);
        }
    }

    @-moz-keyframes loadCategory {
        from {
            transform: scale(1);
        }
        to {
            transform: scale(0.1);
        }
    }

    @-o-keyframes loadCategory {
        from {
            transform: scale(1);
        }
        to {
            transform: scale(0.1);
        }
    }

    .head .img {
        display: inline-block;
        vertical-align: middle;
        width: 24px;
        height: 24px;
        margin-right: 5px;
        border-radius: 50%;
    }

    .head .img>img{
        height:100%;
    }
    .repairList > span {
        -webkit-box-sizing: border-box;
        -moz-box-sizing: border-box;
        box-sizing: border-box;
        display: inline-block;
        vertical-align: top;
        margin: 20px 10px 10px 5px;
    }
    .repairList li .img {
        /*-moz-box-shadow: inset 0 0 30px rgba(0, 0, 0, .3);
        -webkit-box-shadow: inset 0 0 30px rgba(0, 0, 0, .3);
        box-shadow: inset 0 0 30px rgba(0, 0, 0, .3);*/
        margin: 10px;
        width: 50px;
        height: 50px;
        border-radius: 50%;
        /*background-size: contain;
        background-repeat: no-repeat;
        background-position: 50% 50%;*/
    }
    .repairList li .img>img{
        height:100%;
    }
    .repair-table{
        width: 680px;
        height:240px;
        border: 1px solid #c1c4bc;
        overflow-y: auto;;
    }
    @media (max-width:767px){
        .repair-table{
            width: 100%;
        }
    }
    #repair tr{
        height:40px;
     }
    #repairs td {
        vertical-align: middle;
    }

    td.img > span {
        display: block;
        width: 30px;
        height: 30px;
        margin: 0 0 8px 5px;
    }

    td.name {
        padding: 0 12px;
    }

    td.price {
        padding-left: 10px;
        font-weight: 700;
    }

    .device-name {
        margin: 20px 0;
    }

    #my-device .img {
        display: inline-block;
        width: 60px;
        height: 60px;
        margin-left: 20px;
        background-size: contain;
        margin-right: 5px;
        background-repeat: no-repeat;
        background-position: 50% 50%;
    }

    #my-device .name {
        display: inline-block;
        font: 700 16px/1.55 "SF Pro Display","Helvetica Neue","Helvetica","Arial",sans-serif;
        color: #000;
        padding-left: 16px;
    }

    .repair-selected {
        margin-top: 20px;
    }

    #reapirs-selected li {
        line-height: 30px;
    }

    #reapirs-selected li{
        color: #333;
    }

    #poll-answers input.radio ,#shipping-store input.radio{
        float: right;
        width: 20%;
        margin-right: 40%;
    }

    #shipping-store,#shipNewAddress,#billing-new-address-form,#ship-form-address{display: none;}
    #shipping-store.loading,#billing-new-address-form.loading,#ship-form-address.loading{display: block;}
    #shipNewAddress.loading{
        display: block;
        border:1px solid #c1c4bc;
        padding: 20px 14px;
    }
    /*loading*/
    #ajaxloading,#ajaxerror{display: none;}
    #ajaxloading.loading,#ajaxerror.loading{display: block;}
    #ajaxloading.loading{margin-left: -50px;}
    #ajaxloading,#ajaxloading.loading{display: none\9;}
    .spinner {
        margin: 100px auto;
        width: 50px;
        height: 60px;
        text-align: center;
        font-size: 10px;
    }

    .spinner > div {
        background-color: #2db8c7;
        height: 100%;
        width: 6px;
        display: inline-block;

        -webkit-animation: stretchdelay 1.2s infinite ease-in-out;
        animation: stretchdelay 1.2s infinite ease-in-out;
    }

    .spinner .rect2 {
        -webkit-animation-delay: -1.1s;
        animation-delay: -1.1s;
    }

    .spinner .rect3 {
        -webkit-animation-delay: -1.0s;
        animation-delay: -1.0s;
    }

    .spinner .rect4 {
        -webkit-animation-delay: -0.9s;
        animation-delay: -0.9s;
    }

    .spinner .rect5 {
        -webkit-animation-delay: -0.8s;
        animation-delay: -0.8s;
    }
    .repair-form .nav-down-arrow{
        display: block;
        right: 10px;
        top: 16px;
        position: absolute;
        width: 0;
        height: 0;
        border-style: solid;
        border-width: 5px 4.5px 0 4.5px;
        border-color: #000000 transparent transparent transparent;
        line-height: 0px;
    }

    .form-list .notice{
        color: #2db8c7;
        font-size: 14px;
    }
    .head .nav-down-arrow.loading{
        display: none;
    }
    #co-billing-form h3,.shipHead {
        font-weight: 600;
        color: #404040;
        font-size: 16px;
        text-align: left;
        border-bottom: 1px solid #b6b6b6;
        padding-bottom: 8px;
        line-height: 1;
        margin-bottom: 20px;
        text-transform: none;
    }
    .control input.checkbox{
        width: auto;
    }
    .other_outer{display: none;}
    .other_outer.loading{display: block;}
    #ie_ajax{display: none;}
    #ie_ajax.loading{display: block\9;}
    @-webkit-keyframes stretchdelay {
        0%, 40%, 100% { -webkit-transform: scaleY(0.4) }
        20% { -webkit-transform: scaleY(1.0) }
    }

    @keyframes stretchdelay {
        0%, 40%, 100% {
            transform: scaleY(0.4);
            -webkit-transform: scaleY(0.4);
        }  20% {
               transform: scaleY(1.0);
               -webkit-transform: scaleY(1.0);
           }
    }
</style>

<?php echo $this->getMessagesBlock()->toHtml() ?>
<div class="page-title repair-head">
    <h1><?php echo $this->__('REPARATIONER'); ?></h1>
</div>
<div class="repair-form">
    <form action="<?php echo Mage::helper('repairdevice')->getSaveUrl() ?>" method="post" id="new-form" enctype="multipart/form-data">
        <fieldset>
            <?php echo $this->getBlockHtml('formkey'); ?>
            <input type="hidden" name="customer_id" value="<?php echo $this->getCustomerId() ?>"/>
            <h2 class="repair-title"><span class="repair-step"><span>1</span></span><span><?php echo $this->__('Välj modell att laga'); ?></span>
            </h2>
            <div class="row listBox">
                <div class="col-sm-1"></div>
                <div class="col-sm-5 fs_box">
                    <h4><?php echo $this->__('märke:'); ?></h4>
                    <div id="catHead" class="head"></div>
                    <ul id="categoryList" class="repairList"></ul>
                    <div class="first_step"></div>
                </div>
                <div class="col-sm-5 products_listbox">
                    <h4><?php echo $this->__('Model:'); ?></h4>
                    <div id="proHead" class="head"></div>
                    <ul id="productList" class="repairList"></ul>
                </div>
                <div class="col-sm-6"></div>
                <div class="col-sm-5 other_outer">
                    <h4><?php echo $this->__(''); ?></h4>
                    <div id="otherHead" class="head"></div>
                    <ul id="otherList" class="repairList"></ul>
                </div>
            </div>
            <p id="ajaxerror" style="font-size: 20px;margin:40px auto;text-align: center;">This service will be provided soon.</p>
            <div id="ie_ajax" style="width: 60px;height: 60px;margin:40px auto;">
                <img src="/media/repair/loading_ie.gif">
            </div>
            <div id="ajaxloading">
                <div class="spinner">
                    <div class="rect1"></div>
                    <div class="rect2"></div>
                    <div class="rect3"></div>
                    <div class="rect4"></div>
                    <div class="rect5"></div>
                </div>
            </div>
            <div id="repair-block" style="display: none">
                <div id="product-image"></div>
                <div class="device-name"><span>Vald modell: </span><span id="my-device"></span></div>
                <h2 class="repair-title"><span class="repair-step"><span>2</span></span><span>Välj typ av reparation</span></h2>
                <div class="repair-table">
                    <table id="repairs">
                        <thead>
                        <tr>
                            <td></td>
                            <td class="name">Typ av reparation</td>
                            <td class="price">Price</td>
                            <td class="check">Välj</td>
                        </tr>
                        </thead>
                        <!--ajax product list-->
                        <tbody></tbody>
                    </table>
                </div>
                <div class="validation-advice selectWarn" style="display: none;">Detta är ett obligatoriskt fält.</div>
                <div class="repair-selected">
                    <span>Min reparation:</span>
                    <span class="no-select">Ingen typ av reparation vald</span>
                    <!--selected list-->
                    <ul id="reapirs-selected"></ul>
                </div>
                    <div class=" customerPart">
                        <div class="device-info">
                            <h2 class="repair-title"><span class="repair-step"><span>3</span></span><span>Enhetsinformation</span>
                            </h2>
                            <div class="row">
                                <div class="col-sm-6"><h4>Serie/IMEI-nummer:</h4>
                                    <input name="imei" id="imei" class="input-text required-entry" type="text"/>
                                </div>
                                <div class="col-sm-6"><h4>Skärmlås:</h4>
                                    <input type="text" name="screencode" id="screencode" class="input-text required-entry" value=""/>
                                </div>
                                <div class="col-sm-12">
                                    <h4><span class="req-item">*</span>Beskriv problemet:</h4>
                                    <textarea name="detailed" id="detailed" cols="5" rows="3" class="required-entry"></textarea>
                                </div>
                                <p class="req-info"><span class="req-item">*</span>Måsta vara ifyllt</p></div>
                        </div>
                        <div class="shipping-info">
                            <h2 class="repair-title">
                                <span class="repair-step">
                                    <span>4</span>
                                </span>
                                <span>VÄLJ OM ENHETEN SKA SKICKAS ELLER LÄMNAS I BUTIK</span>
                            </h2>
							
                            <div class="shipping-methods">
                                <ul id="poll-answers">
                                    <li>
                                        <input name="shipping_store" type="radio" value="0" title="Existing" id="store_box" class="radio store">
                                        <span class="label"><label for="vote_1"><?php echo $this->__('Lämna i butik'); ?></label></span>

                                        <ul id="shipping-store">
                                            <li><span class="label"><label>Välj butik:</label></span></li>
                                            <li>
                                                <input name="shipping_method" type="radio" value="2" title="Existing" id="2new" class="radio poll_vote">
                                                <span class="label"><label for="vote_1"><?php echo $this->__('Kungsgatan 29, 11156 Stockholm, Sverige'); ?></label></span>
                                            </li>
                                            <li>
                                                <input name="shipping_method" type="radio" value="3" title="Existing" id="3new" class="radio poll_vote">
                                                <span class="label"><label for="vote_1"><?php echo $this->__('Tivolivägen 2, 12631 Hägersten, Sverige'); ?></label></span>
                                            </li>
                                        </ul>
                                    </li>
                                    <li>
                                        <input name="shipping_method" type="radio" value="1" title="New" id="1new" class="radio poll_vote">
                                       <!-- <input name="shipping_address" type="text" value="" title="New" id="post_shipping_address" class="radio poll_vote">-->
                                        <span class="label"><label for="vote_1"><?php echo $this->__('Skicka in med post'); ?></label></span>
                                    </li>
                                </ul>
                                <div id="shipNewAddress">
                                    <?php echo $this->getChildHtml('repairdevice.billing'); ?>
                                </div>
                            </div>
                            <div class="shippingWarn validation-advice" style="display: none;">Detta är ett
                                obligatoriskt fält.
                            </div>
                        </div>
                        <button type="submit" class="k-button k-primary" id="order">Beställ</button>
                    </div>
            </div>
        </fieldset>
		<input type="hidden" name="invoice_status" value="1"> 
    </form>
    <p id="login_status" data-status="<?php if (Mage::getSingleton('customer/session')->isLoggedIn()): ?>1<?php else: ?>0<?php endif; ?>"></p>
</div>
<style>

    #reloading_modal .modal-content>img{margin-left: -20px;}
    #myModal .login{float: right;}
    #myModal .modal-dialog{margin:200px auto 0 auto;}
    #myModal .content {
        min-height: 345px;
        padding: 14px 21px;
        border: 1px solid #ddd;
        border-bottom: 0;
        background: #ffffff;
    }
    #myModal .modal-body>h3{
        margin-bottom: 20px;
        font-size: 18px;
        font-weight: normal;
    }
    #myModal .buttons-set{
        margin: 0 0 10px 0;
        padding: 8px 0;
        border: 1px solid #e4e4e4;}
    #myModal .buttons-set a{
        line-height: 40px;
        margin-left: 20px;
    }
    #myModal .btn-default{
        background: #fc6908;
    }
    @media (min-width: 768px){
        #myModal .modal-dialog {
            width: 700px;
            margin: 30px auto;}
    }
    @media (max-width: 767px){
        #myModal .login{float: none;}
        #myModal .content{min-height: initial;}
        #myModal .modal-dialog {
            width: 96%;
            margin: 120px auto 40px auto;}
        #myModal{
            top:-100px;
        }
        .modal-content{border-radius: 2px;}
        #reloading_modal .modal-content>img{margin-left:0;}
    }
    #myModalLabel{font-weight: normal;font-size: 20px;}
    #reloading_modal.fade.in{opacity: 0.5;background: #000;}
    #reloading_modal .modal-dialog{width:40px;margin:400px auto 0 auto;}
    #reloading_modal .modal-content{border:none;background: none;box-shadow: none;}
</style>
<!-- edit by Jerry -->
<!-- reloading（Modal） -->
<div class="modal fade" id="reloading_modal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel"
     aria-hidden="true" data-keyboard="false" data-backdrop="static">
    <div class="modal-dialog">
        <div class="modal-content">
            <img src="/media/repair/loading_ie.gif">
        </div><!-- /.modal-content -->
    </div><!-- /.modal -->
</div>
<div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×
                </button>
                <h4 class="modal-title" id="myModalLabel">
                    Please login in at first
                </h4>
            </div>
            <div class="modal-body">
                <h3>If you want to have your phone repaired , please login in at first:</h3>
                <div class="row">
                    <div class="col-sm-6 login">
                        <form action="<?php echo Mage::helper('repairdevice')->getSaveLogUrl() ?>" method="post">
                        <div class="content">
                            <h2>Befintlig kund? Logga in</h2>
                            <p>Om du redan har ett konto hos oss, vänligen logga in.</p>
                                <ul class="form-list">
                                    <li>
                                        <label for="email" class="required"><em>*</em>E-postadress</label>
                                        <div class="input-box">
                                            <input class="input-text required-entry validate-email" id="email" type="email" name="login[username]" autocapitalize="off" autocorrect="off" spellcheck="false" >
                                        </div>
                                    </li>
                                    <li>
                                        <label for="pass" class="required"><em>*</em>Lösenord</label>
                                        <div class="input-box">
                                            <input class="input-text required-entry validate-password" id="pass" type="password" name="login[password]" >
                                        </div>
                                    </li>
                                </ul>
                            <p class="required">* Obligatoriska fält</p>
                        </div>
                        <div class="buttons-set">
                            <button type="submit" class="button"  name="send" id="sendLogin" title="<?php echo $this->__('Log in'); ?>"><span><span><?php echo $this->__('Log in'); ?></span></span></button>
                            <span class="f-left"><a href="/customer/account/forgotpassword/"><?php echo $this->__('Forgot Your Password?') ?></a></span>
                        </div>
                        </form>
                    </div>
                    <div class="col-sm-6">
                        <div class="content">
                            <h2><?php echo $this->__('New Customers') ?></h2>
                            <p><?php echo $this->__('By creating an account with our store, you will be able to move through the checkout process faster, store multiple shipping addresses, view and track your orders in your account and more.') ?></p>
                        </div>
                        <div class="buttons-set">
                            <button type="button" title="<?php echo $this->__('Create an Account') ?>" class="button" onclick="window.location='<?php echo $repairUrl.'/customer/account/create/'?>';"><span><span><?php echo $this->__('Create an Account') ?></span></span></button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
            </div>
        </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
</div><!-- /.modal -->
<script type="text/javascript">
    //<![CDATA[
    var awrmaNewForm = new VarienForm('new-form', true);
    //]]>
</script>
<script type="text/javascript">
    jQuery(document).ready(function ($) {
        var reloading_obj;
        var step = 0;
        //1,*****find sessionStorage*****
        if(sessionStorage._repair){
            $("#reloading_modal").modal('show');
            reloading_obj = JSON.parse(sessionStorage._repair);
        }
        function handle_repair() {
            var repair_val;
            if(sessionStorage._repair){
                switch (step){
                    case 1:
                        log(step+', load category.');
                        repair_val = reloading_obj.brand;
                        $("#categoryList li").each(function(){
                            if($(this).attr("data-id") === repair_val)
                                $(this).click();
                        });
                        break;
                    case 2:
                        log(step+', load model.');
                        repair_val = reloading_obj.model;
                        $("#productList li").each(function(){
                            if($(this).attr("data-id") === repair_val)
                                $(this).click();
                        });
                        break;
                    case 3:
                        log(step+', load other.');
                        repair_val = reloading_obj.other;
                        $("#otherList li").each(function(){
                            if($(this).attr("data-id") === repair_val)
                                $(this).click();
                        });
                        break;
                    case 4:
                        log(step+', load product list.');

                        var arr_list = reloading_obj.repair_list;

                        for(var m = 0;m < arr_list.length;m++){
                            $("#repairs .my-repair").each(function(){
                                if($(this).val() === arr_list[m])
                                    $(this).click();
                            });
                        }
                        $('#reapirs-selected').empty();
                        var selected = 0;
                        jQuery('input.my-repair:checkbox:checked').each(function () {
                            selected++;
                            $('#reapirs-selected').append('<li>' + selected + '. ' + jQuery(this).attr('title') + '</li>');
                            $('.no-select').hide();
                        });

                        //other info
                        $("#imei").val(reloading_obj.imei);
                        $("#screencode").val(reloading_obj.screen_code);
                        $("#detailed").val(reloading_obj.detailed);
                        $("#reloading_modal").modal('hide');
                        log('*, fill text.');
                        break;
                    default:
                        log(step+', default');
                        break;
                }
            }
        }
        function log(msg) {
            if(window.console){
                console.log(msg);
            }
        }
        /**
         * Ajax category by id.
         * */
        function ajaxCategory(id, method, sort) {
            var mtd = method;
            if (jQuery.ajax) {
                jQuery.ajax({
                    type: "get",
                    async: true,
                    url: "<?php echo $repairUrl . 'repairdevice/index/category'?>",
                    data: {id: id},
                    dataType: "json",
                    beforeSend: function () {
                        $("#repair-block").hide();
                        repairs.init();
                        selected.init();
                        $('.no-select').show();
                        ajaxerror.loaded();
                        if (mtd === 'category' && sort === 0) {
                            catHead.loading();
                            proHead.init();
                            productList.init();
                            repairs.init();
                            cDown.loading();
                        } else if (mtd === 'category' && sort === 1) {
                            otherBox.loaded();
                            proHead.loading();
                            proHead.init();
                            productList.init();
                            repairs.init();
                            pDown.loading();
                        } else if (mtd === 'category' && sort === 2) {
                            /*
                            *when choose 'mac'
                            *show other box
                            * */
                            otherHead.loading();
                            otherHead.init();
                            otherList.init();
                            repairs.init();
                            oDown.loading();
                            otherBox.loading();
                        }
                    },
                    complete: function () {
                        if (mtd === 'category' && sort === 0) {
                            catHead.loaded();
                            cDown.loaded();
                        } else if (mtd === 'category' && sort === 1) {
                            pDown.loaded();
                            proHead.loaded();
                        } else if (mtd === 'category' && sort === 2) {
                            oDown.loaded();
                            otherHead.loaded();
                        }
                    },
                    success: function (data) {
                        var tmpData = data;
                        var len = tmpData.length;
                        var str = '';
                        if(len <= 0 && sort === 2){
                            otherBox.loaded();
                            otherHead.setCtn("För närvarande finns inget val!");
                            ajaxerror.loading();
                            return false;
                        }
                        if (len <= 0) {
                            return false;
                        }
                        for (var j = 0; j < len; j++) {
                            str += '<li class="clearfix" data-id="' + tmpData[j].id + '"><span class="img"><img class="img-responsive" src="'+tmpData[j].image+'"></span><span class="name">' + tmpData[j].name + '</span></li>';
                        }
                        if (mtd === 'category' && sort === 0) {
                            $("#categoryList").html(str);

                        } else if (mtd === 'category' && sort === 1) {
                            $("#productList").html(str);
                            productList.showList();
                        } else if (mtd === 'category' && sort === 2) {
                            $("#otherList").html(str);
                            otherList.showList();
                        }
                        if(sort === 0){
                            step = 1;
                        }else if(sort === 1){
                            step = 2;
                        }else if(sort === 2){
                            step = 3;
                        }
                        handle_repair();
                    }
                });
            } else {
                if (window.console.log)
                    console.log("error : your browser not supported ajax.");
            }
        }
        /**
         * Ajax product by id.
         * */
        function ajaxProduct(id, method, sort) {
            var mtd = method;
            if (jQuery.ajax) {
                jQuery.ajax({
                    type: "get",
                    async: true,
                    url: "<?php echo $repairUrl . 'repairdevice/index/product'?>",
                    data: {id: id},
                    dataType: "json",
                    beforeSend: function () {
                        ajaxerror.loaded();
                        $("#repair-block").hide();
                        repairs.init();
                        selected.init();
                        $('.no-select').show();
                        showLoading.loading();
                        ieLoading.loading();
                    },
                    complete: function () {
                        showLoading.loaded();
                        ieLoading.loaded();
                    },
                    success: function (data) {
                        var tmpData = data;
                        var len = tmpData.length;
                        var str = '';
                        if (len <= 0) {
                            ajaxerror.loading();
                            return false;
                        }
                        for (var j = 0; j < len; j++) {
                            str += '<tr>' +
                                '<td class="img"><span><img style="width: 30px;height: 30px;margin-bottom: 6px;" src="' + tmpData[j].image + '"/></span></td>' +
                                '<td class="name">' + tmpData[j].name + '</td>' +
                                '<td class="price">' + tmpData[j].price + '</td>' +
                                '<td class="check"><input class="my-repair" name="repairs[]" value="' + tmpData[j].id + '" title="' + tmpData[j].name + '" id="' + tmpData[j].id + '" type="checkbox"><label for="' + tmpData[j].id + '"></label></td></tr>';

                        }
                        if (mtd === 'product' && sort === 0) {} else if (mtd === 'product' && sort === 1) {}
                        repairs.setHtml(str);
                        $("#repair-block").show();
                        step = 4;
                        handle_repair();
                    },
                    error: function () {
                        alert("Ajax error!");
                    }
                });
            } else {
                if (window.console.log)
                    console.log("error : your browser not supported ajax.");
            }
        }
        //catHead proHead
        var catHead = new RepairList("#catHead", "<span>Välj märke</span><span class='nav-down-arrow'></span>");
        var proHead = new RepairList("#proHead", "<span>Välj model</span><span class='nav-down-arrow'></span>");
        var otherHead = new RepairList("#otherHead","<span>Välj</span><span class='nav-down-arrow'></span>");
        var cDown = new RepairList("#catHead .nav-down-arrow","");
        var pDown = new RepairList("#proHead .nav-down-arrow","");
        var oDown = new RepairList("#otherHead .nav-down-arrow","");
        //categoryList productList
        var categoryList = new RepairList("#categoryList", '');
        var productList = new RepairList("#productList", '');
        var otherList = new RepairList("#otherList",'');
        var repairs = new RepairList("#repairs tbody", '');
        //product list
        var selected = new RepairList("#reapirs-selected", '');
        //loading
        var showLoading = new RepairList("#ajaxloading",'');
        var ajaxerror = new RepairList("#ajaxerror",'');
        var ieLoading = new RepairList("#ie_ajax",'');
        //my-device
        var mydevice = new RepairList("#my-device", '');
        //ship to store
        var shipStore = new RepairList("#shipping-store", '');
        var newAddress = new RepairList("#shipNewAddress",'');
        var billingNewForm = new RepairList("#billing-new-address-form",'');
        var addShipAddress = new RepairList("#ship-form-address",'');
        //var other box
        var otherBox = new RepairList(".other_outer","");
        //create object 'RepairList'
        function RepairList(id, inner) {
            this.id = id;
            this.inner = inner;
            this.init = function () {
                var $el = $(id);
                $el.html(inner);
            };
            this.setCtn = function (ctn) {
                var $el = $(id);
                $el.html(ctn);
            };
            this.loading = function () {
                var $el = $(id);
                $el.addClass("loading");
            };
            this.loaded = function () {
                var $el = $(id);
                $el.removeClass("loading");
            };
            this.showList = function () {
                var $el = $(id);
                hideRepairList();
                $el.addClass("active");
            };
            this.hideList = function () {
                var $el = $(id);
                $el.removeClass("active");
            };
            this.setHtml = function (str) {
                var $el = $(id);
                $el.html(str);
            }
        }


        //init
        catHead.init();
        proHead.init();
        otherHead.init();
        otherBox.loaded();


        $("#billing-address-select").attr("onchange",''); // billing address select onchange initialize
        $("#poll-answers input").attr("checked",false);
        ajaxCategory(2502, 'category', 0);//First load categoryList
        //2,*****handle sessionStorage*****


        // show option list when click head
        $(".head").click(function () {
            var $head = $(this);
            var $repairList = $head.parent().find(".repairList");
            hideRepairList();
            if ($repairList.children("li").length > 0) {
                $repairList.addClass("active");
            }
        });

        // set nav-down-arrow when click
        $(".head").delegate(".nav-down-arrow","click",function(){
            $(this).parent(".head").click();
        });

        // set head when click category box and model box
        $(".repairList").delegate("li", "click", function () {
            var $li = $(this);
            if (!$li.hasClass("repair")) {
                $li.parent().parent().find(".head").html($li.html() + '<span class="nav-down-arrow"></span>');

                $li.parent().parent().find(".head>.img").attr('data-id',$li.attr("data-id"));
            }
            hideRepairList();
            if ($("#proHead").find(".name").length === 1) {
                mydevice.setCtn($("#proHead").html());
            }
        });

        $("#categoryList").delegate("li", 'click', function () {
            var tmpId = $(this).attr("data-id");
            ajaxCategory(tmpId, 'category', 1);// ajax model
            $("#repair-block").hide();// hide repair block
        });
        $("#productList").delegate("li", "click", function () {
            var tmpId = $(this).attr("data-id");
            repairs.init();// repair product initialize

            /*
            *show more choice when choose mac
            * Category id of Mac : 2636
            */
            if($("#catHead .img").attr("data-id") === "2641" ){
                ajaxCategory(tmpId,'category',2);
            }else{
                ajaxProduct(tmpId, 'product');// ajax products
            }
        });
        $("#otherList").delegate("li","click",function () {
            var tmpId = $(this).attr("data-id");
            repairs.init();// repair product initialize
            ajaxProduct(tmpId, 'product');// ajax products
        });
        //select product => add to "selected box" ($('#reapirs-selected'))
        $(document).on('click', '.my-repair', function () {
            var selected = 0;
            $('#reapirs-selected').empty();
            jQuery('input.my-repair:checkbox:checked').each(function () {
                selected++;
                $('#reapirs-selected').append('<li>' + selected + '. ' + jQuery(this).attr('title') + '</li>');
                $('.no-select').hide();
            });
            if (selected == 0) {
                $('.no-select').show();
            }
            if ($(this).is(':checked')) {
                $(this).closest('tr').addClass('checked');
            }else {
                $(this).closest('tr').removeClass('checked');
            }
        });
        //choose shipping method
        $(document).on('click','#poll-answers .radio',function(){
            //shipping-store checked , and choose store  #store_box
            if($('#poll-answers #store_box:radio:checked').attr("checked") && $(this).hasClass("store")){
                newAddress.loaded();//hide shipping address
                shipStore.loading();//show shipping store-list
                $("#1new:radio").attr("checked",false);//set method post false
            }
            //user post checked , value = 1
            if($('#poll-answers #1new:radio:checked').attr("checked") && !$(this).hasClass("store")
                && $("#login_status").attr("data-status") === '1'){
                //user login successfully , there exist option 'new address' and 'exist address'
                if ($("#billing-address-select").length > 0 ) {
                    newAddress.loading();//show new address box
                    shipStore.loaded();//hide store box
                    $("#store_box:radio,#shipping-store input:radio").attr("checked", false);//set store input false
                } else if ($("#billing-address-select").length === 0) { //user not login , there not exist address-select box
                    newAddress.loading();//show new address box
                    billingNewForm.loading();//show billing new address
                    shipStore.loaded();//hide store box
                    $("#store_box:radio,#shipping-store input:radio").attr("checked", false);//set store input false
                }
            }
            if(($('#poll-answers #1new:radio:checked').attr("checked") && !$(this).hasClass("store"))
                && ($("#login_status").attr("data-status") < 1)){

                shipStore.loaded();//hide store box
                $("#store_box:radio,#shipping-store input:radio").attr("checked", false);//set store input false

                //1，create repair obj to save user's option
                var repair_obj2 = {
                    "status":"0",
                    "brand":$("#catHead>.img").attr("data-id"),
                    "model":$("#proHead>.img").attr("data-id"),
                    "other":"0",
                    "repair_list":[],
                    "imei":$("#imei").val(),
                    "screen_code":$("#screencode").val(),
                    "detailed":$("#detailed").val()
                };

                if($("#otherHead>.img").length > 0){
                    repair_obj2.other = $("#otherHead>.img").attr("data-id");
                }
                var $selected_list = $('#repairs input.my-repair:checkbox:checked');
                for(var l = 0;l < $selected_list.length;l++){
                    repair_obj2.repair_list[l] =  $selected_list.eq(l).val();
                }

                //2，save repair message at sessionStorage
                var repair_str2 = JSON.stringify(repair_obj2);
                sessionStorage._repair = repair_str2;
                $("#myModal").modal({show: true, keyboard: true});
            }
        });
        //make change between new address and old address
        $(document).on('click','#billing-address-select',function(){
            $("#billing-address-select").change(function () {
                if(!$(this).val()){ // choose new address
                    billingNewForm.loading();
                }
                if($(this).val()>0){// choose exist address
                    billingNewForm.loaded();
                }
            });
            if(!$("#billing-address-select").val()){ // no old address , so show the new address
                billingNewForm.loading();
            }
        });
        //make change on use-bill-address-as-ship-address
        $("#co-billing-form .bill_use_for_address").attr("checked",true); addShipAddress.loaded(); //initialize use-bill-address-as-ship-addresss and set it checked
        $(document).on('click','#co-billing-form .bill_use_for_address',function(){
            if($(this).is(':checked')){
                addShipAddress.loaded();
            }else{
                addShipAddress.loading();
            }
        });
        //hide all repairList when click element of option
        function hideRepairList() {
            categoryList.hideList();
            productList.hideList();
            otherList.hideList();
        }

        //hide all repairlist when click other elements
        $(document).click(function (e) {
            if (!$(e.target).hasClass("head") &&
                !$(e.target).hasClass("repairList") &&
                !$(e.target).parent().hasClass("head") &&
                !$(e.target).hasClass("nav-down-arrow")&&!$(e.target).hasClass("img") &&
                !$(e.target).hasClass("name")&&!$(e.target).parent().hasClass("img")
            ){
                $(".repairList").removeClass("active");
            }
        });

        //form validate and submit
        $("#order").click(function (event) {
            //1 , first , form validate
            var event = event || window.event;

            awrmaNewForm.validator.validate();// form validate

            var $shippingMethod = $(".shipping-methods .poll_vote:radio:checked");//get shipping method
            //alert("$shippingMethod.val" + $shippingMethod.val());

            if ($shippingMethod.length <= 0) { //validate if there exist shipping method
                $(".shipping-info .shipping-methods").addClass("validation-failed");
                $(".shippingWarn").show();
                event.preventDefault(); // Compatible standard Browsers
                window.event.returnValue = false; // Compatible IE6~8
                return false;
            } else if ($shippingMethod.length === 1) {
                $(".shipping-info .shipping-methods").removeClass("validation-failed");
                $(".shippingWarn").hide();
            }

            if($("#repairs input[type='checkbox']:checked").length <= 0){ //validate product list if there exist products selected by customer
                $(".repair-table").addClass("validation-failed");
                $(".selectWarn").show();
                event.preventDefault(); // Compatible standard Browsers
                window.event.returnValue = false; // Compatible IE6~8
            }else{
                $(".repair-table").removeClass("validation-failed");
                $(".selectWarn").hide();
            }

            //2 , validate success , update form by remove some elements
            //deal with sessionStorage
            if($("#login_status").attr("data-status") < 1){
                //1，create repair obj to save user's option
                var repair_obj = {
                    "status":"0",
                    "brand":$("#catHead>.img").attr("data-id"),
                    "model":$("#proHead>.img").attr("data-id"),
                    "other":"0",
                    "repair_list":[],
                    "imei":$("#imei").val(),
                    "screen_code":$("#screencode").val(),
                    "detailed":$("#detailed").val()
                };

                if($("#otherHead>.img").length > 0){
                    repair_obj.other = $("#otherHead>.img").attr("data-id");
                }
                var $selected_list = $('#repairs input.my-repair:checkbox:checked');
                for(var l = 0;l < $selected_list.length;l++){
                    repair_obj.repair_list[l] =  $selected_list.eq(l).val();
                }

                //2，save repair message at sessionStorage
                var repair_str = JSON.stringify(repair_obj);
                sessionStorage._repair = repair_str;

                //3,show login and register
                $("#myModal").modal({show:true,keyboard: true});

                event.preventDefault();
                window.event.returnValue = false;
            }

            // before submit remove some input elements , when customer have signed in.
            if($("#login_status").attr("data-status") === '1'){

                //sessionStorage._repair = "";//init _repair
                sessionStorage.removeItem("_repair");
                $("#myModal").modal({show:false});

                if($('#poll-answers #store_box:radio:checked').attr("checked")){//customer choose store
                    $("#billing-new-address-form").remove();
                    $("#billing-address-select").remove();
                    $("#ship-form-address").remove();
                    $(".bill_use_for_address").remove();
                }
                if(!$('#poll-answers #store_box:radio:checked').attr("checked")) {
                    //old bill , same shipping
                    if ($("#billing-address-select").val() > 0 && $("#co-billing-form .bill_use_for_address").is(':checked')) {
                        $("#billing-new-address-form").remove();
                        $("#ship-form-address").remove();
                        //old bill , new shipping
                    } else if ($("#billing-address-select").val() > 0 && !$("#co-billing-form .bill_use_for_address").is(':checked')) {
                        $("#billing-new-address-form").remove();
                        //new bill , same shipping
                    } else if (!$("#billing-address-select").val() && $(".bill_use_for_address").is(':checked')) {
                        $("#ship-form-address").remove();
                        //new bill , new shipping
                    } else if (!$("#billing-address-select").val() && !$(".bill_use_for_address").is(':checked')) {
                    }
                }
            }
        });
    });
</script>